

-----------------------------------AULA 11 - RELATÓRIOS --------------------------

--PASSO 1: RELATORIO DE VENDAS VALIDAS

SELECT * FROM [TABELA DE CLIENTES]

SELECT * FROM [TABELA DE ITENS NOTAS FISCAIS]

SELECT * FROM [TABELA DE NOTAS FISCAIS]

--PASSO 2:  FACO A UNIAO DAS TABELAS QUE TEM OS VALORES QUE EU QUERO
SELECT * FROM [TABELA DE NOTAS FISCAIS] NF
INNER JOIN [TABELA DE ITENS NOTAS FISCAIS]INF
ON NF.NUMERO = INF.NUMERO


--PASSO 3:  PEGO SOMENTE OS CAMPOS QUE EU QUERO
SELECT NF.CPF, NF.DATA,INF.QUANTIDADE FROM [TABELA DE NOTAS FISCAIS] NF
INNER JOIN [TABELA DE ITENS NOTAS FISCAIS]INF
ON NF.NUMERO = INF.NUMERO


--PASSO 4: CONVERTENDO A DATA PARA STRING
SELECT NF.CPF, CONVERT (VARCHAR,NF.DATA,120) AS 'DATA',INF.QUANTIDADE FROM [TABELA DE NOTAS FISCAIS] NF
INNER JOIN [TABELA DE ITENS NOTAS FISCAIS]INF
ON NF.NUMERO = INF.NUMERO


--PASSO 5: USANDO SUBSTRING PARA PEGAR SOMENTE O ANO/MES
SELECT NF.CPF,SUBSTRING (CONVERT(VARCHAR,NF.DATA,120),1,7) AS 'ANO/MES',INF.QUANTIDADE FROM [TABELA DE NOTAS FISCAIS] NF
INNER JOIN [TABELA DE ITENS NOTAS FISCAIS]INF
ON NF.NUMERO = INF.NUMERO




--PASSO 6: AGRUPANDO PARA TER QUANTIDADE POR CPF E MÊS 
SELECT NF.CPF,SUBSTRING (CONVERT(VARCHAR,NF.DATA,120),1,7) AS 'ANO/MES', SUM (INF.QUANTIDADE) AS 'QUANTIDADE MES' FROM [TABELA DE NOTAS FISCAIS] NF
INNER JOIN [TABELA DE ITENS NOTAS FISCAIS]INF
ON NF.NUMERO = INF.NUMERO
GROUP BY NF.CPF, SUBSTRING (CONVERT(VARCHAR,NF.DATA,120),1,7)



--PASSO 7: PEGAR O NOME E VOLUME DE COMPRA DA TABELA DE CLIENTE
SELECT TC.NOME,TC.[VOLUME DE COMPRA] FROM [TABELA DE CLIENTES]TC






--PASSO 8: FAZENDO SUBQUERY DA CONSULTA 
SELECT * FROM
(SELECT NF.CPF,SUBSTRING(CONVERT (VARCHAR,NF.[DATA],103),4,10) AS 'MES/ANO', SUM (INF.QUANTIDADE) AS 'QUANTIDADE MES' FROM [TABELA DE NOTAS FISCAIS]NF
INNER JOIN [TABELA DE ITENS NOTAS FISCAIS]INF
ON NF.NUMERO = INF.NUMERO
GROUP BY  NF.CPF,SUBSTRING(CONVERT (VARCHAR,NF.[DATA],103),4,10))CQ


--PASSO 9: APLICANDO INNER JOIN COM A TABELA DE CLIENTES
SELECT * FROM
(SELECT NF.CPF,SUBSTRING(CONVERT (VARCHAR,NF.[DATA],103),4,10) AS 'MES/ANO', SUM (INF.QUANTIDADE) AS 'QUANTIDADE MES' FROM [TABELA DE NOTAS FISCAIS]NF
INNER JOIN [TABELA DE ITENS NOTAS FISCAIS]INF
ON NF.NUMERO = INF.NUMERO
GROUP BY  NF.CPF,SUBSTRING(CONVERT (VARCHAR,NF.[DATA],103),4,10))CQ
INNER JOIN [TABELA DE CLIENTES]TC
ON TC.CPF = CQ.CPF


--PASSO 10: SELECIONADO SOMENTE AS COLUNAS NECESSARIAS
SELECT TC.NOME,CQ.[ANO/MES], CQ.[QUANTIDADE MES],TC.[VOLUME DE COMPRA]
FROM
(SELECT NF.CPF,SUBSTRING (CONVERT(VARCHAR,NF.DATA,120),1,7) AS 'ANO/MES', SUM (INF.QUANTIDADE) AS 'QUANTIDADE MES' FROM [TABELA DE NOTAS FISCAIS] NF
INNER JOIN [TABELA DE ITENS NOTAS FISCAIS]INF
ON NF.NUMERO = INF.NUMERO
GROUP BY NF.CPF, SUBSTRING (CONVERT(VARCHAR,NF.DATA,120),1,7))CQ --
INNER JOIN [TABELA DE CLIENTES]TC
ON TC.CPF = CQ.CPF



--PASSO 11: ELA VAI SER OUTRA SUBQUERY
--OBSERVEM O APELIDO PESSOAL

SELECT * FROM
(SELECT TC.NOME,CQ.[ANO/MES], CQ.[QUANTIDADE MES],TC.[VOLUME DE COMPRA]
FROM
(SELECT NF.CPF,SUBSTRING (CONVERT(VARCHAR,NF.DATA,120),1,7) AS 'ANO/MES', SUM (INF.QUANTIDADE) AS 'QUANTIDADE MES' FROM [TABELA DE NOTAS FISCAIS] NF
INNER JOIN [TABELA DE ITENS NOTAS FISCAIS]INF
ON NF.NUMERO = INF.NUMERO
GROUP BY NF.CPF, SUBSTRING (CONVERT(VARCHAR,NF.DATA,120),1,7))CQ --
INNER JOIN [TABELA DE CLIENTES]TC
ON TC.CPF = CQ.CPF)AUX


--PASSO 12: PEGANDO SOMENTE O QUE EU QUERO JÁ COM O CASE EMBUTIDO NO SELECT

SELECT AUX.NOME,AUX.[MES/ANO],AUX.[QUANTIDADE MES],AUX.[VOLUME DE COMPRA],
CASE
	WHEN AUX.[QUANTIDADE MES] <= AUX.[VOLUME DE COMPRA] THEN 'VENDA VÁLIDA'
	ELSE 'VENDA INVALIDA' 

END AS 'STATUS DE VENDA'
FROM
(SELECT TC.NOME,CQ.[MES/ANO], CQ.[QUANTIDADE MES],TC.[VOLUME DE COMPRA]
FROM
(SELECT NF.CPF,SUBSTRING(CONVERT (VARCHAR,NF.[DATA],103),4,10) AS 'MES/ANO', SUM (INF.QUANTIDADE) AS 'QUANTIDADE MES' FROM [TABELA DE NOTAS FISCAIS]NF
INNER JOIN [TABELA DE ITENS NOTAS FISCAIS]INF
ON NF.NUMERO = INF.NUMERO
GROUP BY  NF.CPF,SUBSTRING(CONVERT (VARCHAR,NF.[DATA],103),4,10))CQ
INNER JOIN [TABELA DE CLIENTES]TC
ON TC.CPF = CQ.CPF)AUX



--PASSO 13: ORDANANDO PELO ORDER BY PELO NOME E MES/ANO
SELECT AUX.NOME,AUX.[MES/ANO],AUX.[QUANTIDADE MES],AUX.[VOLUME DE COMPRA],
CASE
	WHEN AUX.[QUANTIDADE MES] <= AUX.[VOLUME DE COMPRA] THEN 'VENDA VÁLIDA'
	ELSE 'VENDA INVALIDA' 

END AS 'STATUS DE VENDA'
FROM
(SELECT TC.NOME,CQ.[MES/ANO], CQ.[QUANTIDADE MES],TC.[VOLUME DE COMPRA]
FROM
(SELECT NF.CPF,SUBSTRING(CONVERT (VARCHAR,NF.[DATA],103),4,10) AS 'MES/ANO', SUM (INF.QUANTIDADE) AS 'QUANTIDADE MES' FROM [TABELA DE NOTAS FISCAIS]NF
INNER JOIN [TABELA DE ITENS NOTAS FISCAIS]INF
ON NF.NUMERO = INF.NUMERO
GROUP BY  NF.CPF,SUBSTRING(CONVERT (VARCHAR,NF.[DATA],103),4,10))CQ
INNER JOIN [TABELA DE CLIENTES]TC
ON TC.CPF = CQ.CPF)AUX
ORDER BY AUX.NOME, AUX.[MES/ANO]





-- RESPOSTA DO DESAFIO DO RELATORIO DE VENDA ---------

SELECT AUX.NOME, AUX.[ANO/MES],AUX.[QUANTIDADE MES],AUX.[VOLUME DE COMPRA], 
 ROUND ((1 -(AUX.[VOLUME DE COMPRA]/AUX.[QUANTIDADE MES])) * 100,2)  AS 'PERCENTUAL',


	CASE
		WHEN AUX.[QUANTIDADE MES] <= AUX.[VOLUME DE COMPRA] THEN 'VENDA VÁLIDA'
		ELSE 'VENDA INVALIDA'
	END AS 'STATUS VENDA'
FROM
(SELECT TC.NOME,CQ.[ANO/MES], CQ.[QUANTIDADE MES],TC.[VOLUME DE COMPRA]
FROM
(SELECT NF.CPF,SUBSTRING (CONVERT(VARCHAR,NF.DATA,120),1,7) AS 'ANO/MES', SUM (INF.QUANTIDADE) AS 'QUANTIDADE MES' FROM [TABELA DE NOTAS FISCAIS] NF
INNER JOIN [TABELA DE ITENS NOTAS FISCAIS]INF
ON NF.NUMERO = INF.NUMERO
GROUP BY NF.CPF, SUBSTRING (CONVERT(VARCHAR,NF.DATA,120),1,7))CQ
INNER JOIN [TABELA DE CLIENTES]TC
ON TC.CPF = CQ.CPF)AUX
WHERE  AUX.[QUANTIDADE MES] > AUX.[VOLUME DE COMPRA]
ORDER BY AUX.NOME,AUX.[ANO/MES]



--O  dono da esquina do suco pediu para que mostrasse um relatório mostrando,
--qual foi o  faturamento em dinheiro por sabor de produto e também compararmos 
--a participação daquela venda em relação ao total.
--Somente no ano de 2016

----------------- Relatório de Venda por Sabor -----------------------------



SELECT AUX1.SABOR, AUX1.ANO,ROUND (AUX1.FATURAMENTO,2) AS 'FATURAMENTO', CONVERT(VARCHAR,ROUND((AUX1.FATURAMENTO/AUX2.[FATURAMENTO ANUAL])*100,2))+' %' AS 'PERCENTUAL' FROM
(SELECT TP.SABOR, YEAR (NF.DATA) AS 'ANO', SUM (INF.QUANTIDADE * INF.PRECO) AS 'FATURAMENTO' FROM [TABELA DE ITENS NOTAS FISCAIS]INF
INNER JOIN [TABELA DE NOTAS FISCAIS]NF
ON INF.NUMERO = NF.NUMERO
INNER JOIN [TABELA DE PRODUTOS]TP
ON INF.[CODIGO DO PRODUTO] = TP.[CODIGO DO PRODUTO]
WHERE YEAR (NF.DATA) = 2016
GROUP BY TP.SABOR, YEAR (NF.DATA))AUX1
INNER JOIN (SELECT  YEAR (NF.DATA) AS 'ANO', SUM (INF.QUANTIDADE * INF.PRECO) AS 'FATURAMENTO ANUAL' FROM [TABELA DE ITENS NOTAS FISCAIS]INF
INNER JOIN [TABELA DE NOTAS FISCAIS]NF
ON INF.NUMERO = NF.NUMERO
INNER JOIN [TABELA DE PRODUTOS]TP
ON INF.[CODIGO DO PRODUTO] = TP.[CODIGO DO PRODUTO]
WHERE YEAR (NF.DATA) = 2016
GROUP BY YEAR (NF.DATA))AUX2
ON AUX1.ANO = AUX2.ANO
ORDER BY AUX1.FATURAMENTO DESC

----------------------  PASSO A PASSO --------------------------------------------

--PASSO1: PEGANDO AS TABELAS 
SELECT * FROM [TABELA DE PRODUTOS]

SELECT * FROM [TABELA DE NOTAS FISCAIS]

SELECT * FROM [TABELA DE ITENS NOTAS FISCAIS]


--PASSO 2: PEGANDO OS CAMPOS
SELECT TP.SABOR FROM [TABELA DE PRODUTOS]TP

SELECT NF.DATA FROM [TABELA DE NOTAS FISCAIS]NF

SELECT (INF.QUANTIDADE * INF.PRECO) AS 'FATURAMENTO' FROM [TABELA DE ITENS NOTAS FISCAIS]INF


--PASSO 3: JUNTANDO AS TABELAS
SELECT TP.SABOR, NF.DATA,(INF.QUANTIDADE * INF.PRECO) AS 'FATURAMENTO' FROM [TABELA DE ITENS NOTAS FISCAIS]INF
INNER JOIN [TABELA DE NOTAS FISCAIS]NF
ON INF.NUMERO = NF.NUMERO
INNER JOIN [TABELA DE PRODUTOS]TP
ON INF.[CODIGO DO PRODUTO] = TP.[CODIGO DO PRODUTO]


--PASSO 4: FILTRANDO PELA DATA E DANDO NOME AS COLUNAS 
SELECT TP.SABOR, YEAR (NF.DATA) AS 'ANO', (INF.QUANTIDADE * INF.PRECO) AS 'FATURAMENTO' FROM [TABELA DE ITENS NOTAS FISCAIS]INF
INNER JOIN [TABELA DE NOTAS FISCAIS]NF
ON INF.NUMERO = NF.NUMERO
INNER JOIN [TABELA DE PRODUTOS]TP
ON INF.[CODIGO DO PRODUTO] = TP.[CODIGO DO PRODUTO]
WHERE YEAR (NF.DATA) = 2016



--PASSO 5: AGRUPANDO
SELECT TP.SABOR, YEAR (NF.DATA) AS 'ANO', SUM (INF.QUANTIDADE * INF.PRECO) AS 'FATURAMENTO' FROM [TABELA DE ITENS NOTAS FISCAIS]INF
INNER JOIN [TABELA DE NOTAS FISCAIS]NF
ON INF.NUMERO = NF.NUMERO
INNER JOIN [TABELA DE PRODUTOS]TP
ON INF.[CODIGO DO PRODUTO] = TP.[CODIGO DO PRODUTO]
WHERE YEAR (NF.DATA) = 2016
GROUP BY TP.SABOR, YEAR (NF.DATA)


-- PASSO 6: AGRUPANDO O FATURAMENTO ANUAL (TIRO O CAMPO SABOR) 
SELECT  YEAR (NF.DATA) AS 'ANO', SUM (INF.QUANTIDADE * INF.PRECO) AS 'FATURAMENTO' FROM [TABELA DE ITENS NOTAS FISCAIS]INF
INNER JOIN [TABELA DE NOTAS FISCAIS]NF
ON INF.NUMERO = NF.NUMERO
INNER JOIN [TABELA DE PRODUTOS]TP
ON INF.[CODIGO DO PRODUTO] = TP.[CODIGO DO PRODUTO]
WHERE YEAR (NF.DATA) = 2016
GROUP BY YEAR (NF.DATA)




--SELECT'CAMPO1' ,'CAMPO2' FROM [TABELA DE PRODUTOS]

--PASSO 7: INNER JOIN NAS DUAS CONSULTAS 
SELECT * FROM
(SELECT TP.SABOR, YEAR (NF.DATA) AS 'ANO', SUM (INF.QUANTIDADE * INF.PRECO) AS 'FATURAMENTO' FROM [TABELA DE ITENS NOTAS FISCAIS]INF
INNER JOIN [TABELA DE NOTAS FISCAIS]NF
ON INF.NUMERO = NF.NUMERO
INNER JOIN [TABELA DE PRODUTOS]TP
ON INF.[CODIGO DO PRODUTO] = TP.[CODIGO DO PRODUTO]
WHERE YEAR (NF.DATA) = 2016
GROUP BY TP.SABOR, YEAR (NF.DATA))AUX1

INNER JOIN 

(SELECT  YEAR (NF.DATA) AS 'ANO', SUM (INF.QUANTIDADE * INF.PRECO) AS 'FATURAMENTO' FROM [TABELA DE ITENS NOTAS FISCAIS]INF
INNER JOIN [TABELA DE NOTAS FISCAIS]NF
ON INF.NUMERO = NF.NUMERO
INNER JOIN [TABELA DE PRODUTOS]TP
ON INF.[CODIGO DO PRODUTO] = TP.[CODIGO DO PRODUTO]
WHERE YEAR (NF.DATA) = 2016
GROUP BY YEAR (NF.DATA))AUX2

ON AUX1.ANO = AUX2.ANO




-- PASSO 8: MUDANDO O NOME DO FATURAMENTO DO AUX2 PARA 'FATURAMENTO ANUAL'
SELECT AUX1.SABOR, AUX1.ANO,AUX1.FATURAMENTO,AUX2.[FATURAMENTO ANUAL] FROM
(SELECT TP.SABOR, YEAR (NF.DATA) AS 'ANO', SUM (INF.QUANTIDADE * INF.PRECO) AS 'FATURAMENTO' FROM [TABELA DE ITENS NOTAS FISCAIS]INF
INNER JOIN [TABELA DE NOTAS FISCAIS]NF
ON INF.NUMERO = NF.NUMERO
INNER JOIN [TABELA DE PRODUTOS]TP
ON INF.[CODIGO DO PRODUTO] = TP.[CODIGO DO PRODUTO]
WHERE YEAR (NF.DATA) = 2016
GROUP BY TP.SABOR, YEAR (NF.DATA))AUX1
INNER JOIN (SELECT  YEAR (NF.DATA) AS 'ANO', SUM (INF.QUANTIDADE * INF.PRECO) AS 'FATURAMENTO ANUAL' FROM [TABELA DE ITENS NOTAS FISCAIS]INF
INNER JOIN [TABELA DE NOTAS FISCAIS]NF
ON INF.NUMERO = NF.NUMERO
INNER JOIN [TABELA DE PRODUTOS]TP
ON INF.[CODIGO DO PRODUTO] = TP.[CODIGO DO PRODUTO]
WHERE YEAR (NF.DATA) = 2016
GROUP BY YEAR (NF.DATA))AUX2
ON AUX1.ANO = AUX2.ANO


-- PASSO 9: CRIANDO O PERCENTUAL

SELECT AUX1.SABOR, AUX1.ANO,AUX1.FATURAMENTO,(AUX1.FATURAMENTO/AUX2.[FATURAMENTO ANUAL])*100 AS 'PERCENTUAL' FROM
(SELECT TP.SABOR, YEAR (NF.DATA) AS 'ANO', SUM (INF.QUANTIDADE * INF.PRECO) AS 'FATURAMENTO' FROM [TABELA DE ITENS NOTAS FISCAIS]INF
INNER JOIN [TABELA DE NOTAS FISCAIS]NF
ON INF.NUMERO = NF.NUMERO
INNER JOIN [TABELA DE PRODUTOS]TP
ON INF.[CODIGO DO PRODUTO] = TP.[CODIGO DO PRODUTO]
WHERE YEAR (NF.DATA) = 2016
GROUP BY TP.SABOR, YEAR (NF.DATA))AUX1
INNER JOIN (SELECT  YEAR (NF.DATA) AS 'ANO', SUM (INF.QUANTIDADE * INF.PRECO) AS 'FATURAMENTO ANUAL' FROM [TABELA DE ITENS NOTAS FISCAIS]INF
INNER JOIN [TABELA DE NOTAS FISCAIS]NF
ON INF.NUMERO = NF.NUMERO
INNER JOIN [TABELA DE PRODUTOS]TP
ON INF.[CODIGO DO PRODUTO] = TP.[CODIGO DO PRODUTO]
WHERE YEAR (NF.DATA) = 2016
GROUP BY YEAR (NF.DATA))AUX2
ON AUX1.ANO = AUX2.ANO



--PASSO 10: ORDENANDO PELO FATURAMENTO (AUX1)
SELECT AUX1.SABOR, AUX1.ANO,AUX1.FATURAMENTO,(AUX1.FATURAMENTO/AUX2.[FATURAMENTO ANUAL])*100 AS 'PERCENTUAL' FROM
(SELECT TP.SABOR, YEAR (NF.DATA) AS 'ANO', SUM (INF.QUANTIDADE * INF.PRECO) AS 'FATURAMENTO' FROM [TABELA DE ITENS NOTAS FISCAIS]INF
INNER JOIN [TABELA DE NOTAS FISCAIS]NF
ON INF.NUMERO = NF.NUMERO
INNER JOIN [TABELA DE PRODUTOS]TP
ON INF.[CODIGO DO PRODUTO] = TP.[CODIGO DO PRODUTO]
WHERE YEAR (NF.DATA) = 2016
GROUP BY TP.SABOR, YEAR (NF.DATA))AUX1
INNER JOIN (SELECT  YEAR (NF.DATA) AS 'ANO', SUM (INF.QUANTIDADE * INF.PRECO) AS 'FATURAMENTO ANUAL' FROM [TABELA DE ITENS NOTAS FISCAIS]INF
INNER JOIN [TABELA DE NOTAS FISCAIS]NF
ON INF.NUMERO = NF.NUMERO
INNER JOIN [TABELA DE PRODUTOS]TP
ON INF.[CODIGO DO PRODUTO] = TP.[CODIGO DO PRODUTO]
WHERE YEAR (NF.DATA) = 2016
GROUP BY YEAR (NF.DATA))AUX2
ON AUX1.ANO = AUX2.ANO
ORDER BY AUX1.FATURAMENTO DESC


--PASSO 11: CONVERTENDO E ARRENDONDANDO CAMPOS (FINALIZANDO O RELATÓRIO)

SELECT AUX1.SABOR, AUX1.ANO,ROUND (AUX1.FATURAMENTO,2) AS 'FATURAMENTO', CONVERT(VARCHAR,ROUND((AUX1.FATURAMENTO/AUX2.[FATURAMENTO ANUAL])*100,2))+' %' AS 'PERCENTUAL' FROM
(SELECT TP.SABOR, YEAR (NF.DATA) AS 'ANO', SUM (INF.QUANTIDADE * INF.PRECO) AS 'FATURAMENTO' FROM [TABELA DE ITENS NOTAS FISCAIS]INF
INNER JOIN [TABELA DE NOTAS FISCAIS]NF
ON INF.NUMERO = NF.NUMERO
INNER JOIN [TABELA DE PRODUTOS]TP
ON INF.[CODIGO DO PRODUTO] = TP.[CODIGO DO PRODUTO]
WHERE YEAR (NF.DATA) = 2016
GROUP BY TP.SABOR, YEAR (NF.DATA))AUX1
INNER JOIN (SELECT  YEAR (NF.DATA) AS 'ANO', SUM (INF.QUANTIDADE * INF.PRECO) AS 'FATURAMENTO ANUAL' FROM [TABELA DE ITENS NOTAS FISCAIS]INF
INNER JOIN [TABELA DE NOTAS FISCAIS]NF
ON INF.NUMERO = NF.NUMERO
INNER JOIN [TABELA DE PRODUTOS]TP
ON INF.[CODIGO DO PRODUTO] = TP.[CODIGO DO PRODUTO]
WHERE YEAR (NF.DATA) = 2016
GROUP BY YEAR (NF.DATA))AUX2
ON AUX1.ANO = AUX2.ANO
ORDER BY AUX1.FATURAMENTO DESC



SELECT AUX1.SABOR, AUX1.ANO, FORMAT(CONVERT(DECIMAL(15,2),AUX1.FATURAMENTO),'C','PT-BR') AS 'FATURAMENTO', CONVERT(VARCHAR,ROUND((AUX1.FATURAMENTO/AUX2.[FATURAMENTO ANUAL])*100,2))+' %' AS 'PERCENTUAL' FROM
(SELECT TP.SABOR, YEAR (NF.DATA) AS 'ANO', SUM (INF.QUANTIDADE * INF.PRECO) AS 'FATURAMENTO' FROM [TABELA DE ITENS NOTAS FISCAIS]INF
INNER JOIN [TABELA DE NOTAS FISCAIS]NF
ON INF.NUMERO = NF.NUMERO
INNER JOIN [TABELA DE PRODUTOS]TP
ON INF.[CODIGO DO PRODUTO] = TP.[CODIGO DO PRODUTO]
WHERE YEAR (NF.DATA) = 2016
GROUP BY TP.SABOR, YEAR (NF.DATA))AUX1
INNER JOIN (SELECT  YEAR (NF.DATA) AS 'ANO', SUM (INF.QUANTIDADE * INF.PRECO) AS 'FATURAMENTO ANUAL' FROM [TABELA DE ITENS NOTAS FISCAIS]INF
INNER JOIN [TABELA DE NOTAS FISCAIS]NF
ON INF.NUMERO = NF.NUMERO
INNER JOIN [TABELA DE PRODUTOS]TP
ON INF.[CODIGO DO PRODUTO] = TP.[CODIGO DO PRODUTO]
WHERE YEAR (NF.DATA) = 2016
GROUP BY YEAR (NF.DATA))AUX2
ON AUX1.ANO = AUX2.ANO
ORDER BY AUX1.FATURAMENTO DESC



--OUTRA RESPOSTA COM O FORMAT PARA MOEDA E COM DUAS CASAS DECIMAIS E COM DECIMAL APARECENDO O ZERO NA FORMATACAO DO DECIMAL 'X,10'
--DA DOCUMENTACAO MICROSOFT SOBRE O FORMAT 
 			-- FORMAT(<O NUMERO AQUI>, 'N', 'PT-BR') AS 'Number Format' (FORMATO NUMERICO)
            -- FORMAT(<O NUMERO AQUI>, 'G', 'PT-BR') AS 'General Format'  (FORMATO GERAL)
            -- FORMAT<(O NUMERO AQUI>, 'C', 'PT-BR') AS 'Currency Format'  (FORMATO MOEDA)


SELECT AUX1.SABOR, AUX1.ANO, FORMAT(AUX1.FATURAMENTO,'C','PT-BR') AS 'FATURAMENTO', CONVERT(VARCHAR,ROUND((AUX1.FATURAMENTO/AUX2.[FATURAMENTO ANUAL])*100,2))+' %' AS 'PERCENTUAL' FROM
(SELECT TP.SABOR, YEAR (NF.DATA) AS 'ANO', SUM (INF.QUANTIDADE * INF.PRECO) AS 'FATURAMENTO' FROM [TABELA DE ITENS NOTAS FISCAIS]INF
INNER JOIN [TABELA DE NOTAS FISCAIS]NF
ON INF.NUMERO = NF.NUMERO
INNER JOIN [TABELA DE PRODUTOS]TP
ON INF.[CODIGO DO PRODUTO] = TP.[CODIGO DO PRODUTO]
WHERE YEAR (NF.DATA) = 2016
GROUP BY TP.SABOR, YEAR (NF.DATA))AUX1
INNER JOIN (SELECT  YEAR (NF.DATA) AS 'ANO', SUM (INF.QUANTIDADE * INF.PRECO) AS 'FATURAMENTO ANUAL' FROM [TABELA DE ITENS NOTAS FISCAIS]INF
INNER JOIN [TABELA DE NOTAS FISCAIS]NF
ON INF.NUMERO = NF.NUMERO
INNER JOIN [TABELA DE PRODUTOS]TP
ON INF.[CODIGO DO PRODUTO] = TP.[CODIGO DO PRODUTO]
WHERE YEAR (NF.DATA) = 2016
GROUP BY YEAR (NF.DATA))AUX2
ON AUX1.ANO = AUX2.ANO
ORDER BY AUX1.FATURAMENTO DESC